1ï¸âƒ£ Fix params.chatId Await Issue in route.ts
The error "params should be awaited before using its properties" suggests that params might be coming from context in an async function, and you need to use it correctly.

âœ… Fix in /api/chat/[chatId]/route.ts
Replace:

tsx
Copy
Edit
const chatId = params.chatId;
With:

tsx
Copy
Edit
export async function GET(request, { params }) {
  try {
    if (!params || !params.chatId) {
      console.error("âŒ Missing chatId:", params);
      return NextResponse.json({ error: "Chat ID is required" }, { status: 400 });
    }

    const chatId = params.chatId;
    if (typeof chatId !== "string") {
      console.error("âŒ Invalid chatId type:", typeof chatId);
      return NextResponse.json({ error: "Invalid Chat ID" }, { status: 400 });
    }

    console.log("ğŸ“© Fetching messages for chat:", chatId);
    const { db } = await connectToDatabase();
    const messages = await db.collection("messages").find({ chatId }).toArray();

    return NextResponse.json({ messages });
  } catch (error) {
    console.error("âŒ Error fetching messages:", error.message);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
âœ… Handles missing or invalid chatId
âœ… Ensures database connection before querying

2ï¸âƒ£ Fix Failed to Fetch Chats in chat-list.tsx
The error "Failed to fetch chats" means that the API call to /api/chat is failing. The 405 error means it's trying to use the wrong HTTP method (e.g., POST instead of GET).

âœ… Fix fetchChats() in chat-list.tsx
tsx
Copy
Edit
const fetchChats = async () => {
  try {
    const response = await fetch("/api/chat", {
      method: "GET", // Ensure GET method
      headers: { "Content-Type": "application/json" },
    });

    if (!response.ok) {
      throw new Error(`API Error: ${response.status} - ${response.statusText}`);
    }

    const data = await response.json();
    return data.chats || []; // Ensure 'chats' exists in response
  } catch (error) {
    console.error("âŒ Error fetching chats:", error.message);
    return []; // Prevents UI from breaking
  }
};
âœ… Ensures correct API method (GET)
âœ… Handles fetch errors gracefully

3ï¸âƒ£ Fix 405 Method Not Allowed in /api/chat
If /api/chat is returning 405, it means your API route isn't handling the GET request correctly.

âœ… Fix in /api/chat/route.ts
tsx
Copy
Edit
import { NextResponse } from "next/server";
import { connectToDatabase } from "@/lib/mongodb";

export async function GET() {
  try {
    const { db } = await connectToDatabase();
    if (!db) throw new Error("Database connection failed");

    const chats = await db.collection("chats").find({}).toArray();
    return NextResponse.json({ chats });
  } catch (error) {
    console.error("âŒ Error fetching chats:", error.message);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
âœ… Ensures the GET method works properly
âœ… Prevents crashes if DB connection fails

4ï¸âƒ£ Fix Message Alignment (Like Telegram)
Sent messages should be on the right side, and received messages on the left.

âœ… Fix in Message.tsx
tsx
Copy
Edit
const Message = ({ message, userId }) => {
  const isSentByUser = message.senderId === userId;

  return (
    <div className={`flex ${isSentByUser ? "justify-end" : "justify-start"}`}>
      <div
        className={`p-3 rounded-lg max-w-xs ${
          isSentByUser ? "bg-blue-500 text-white" : "bg-gray-200 text-black"
        }`}
      >
        {message.text}
      </div>
    </div>
  );
};
âœ… Sent messages (userId === senderId) are right-aligned
âœ… Received messages are left-aligned

5ï¸âƒ£ Fix Real-Time Profile Name & Picture Sync
If usernames and profile pictures arenâ€™t updating, ensure theyâ€™re being fetched and updated on state change.

âœ… Fix in useEffect inside chat-list.tsx
tsx
Copy
Edit
useEffect(() => {
  const fetchUsers = async () => {
    try {
      const response = await fetch("/api/users");
      if (!response.ok) throw new Error("Failed to fetch users");

      const data = await response.json();
      setUsers(data.users); // Update state
    } catch (error) {
      console.error("âŒ Error fetching users:", error.message);
    }
  };

  fetchUsers();
}, []);
âœ… Ensures profile updates in real time
âœ… Prevents stale user info

ğŸš€ Final Steps
1ï¸âƒ£ Fix /api/chat/[chatId]/route.ts to await params.chatId properly
2ï¸âƒ£ Ensure fetchChats() uses GET instead of POST
3ï¸âƒ£ Fix 405 Method Not Allowed by correctly handling GET in /api/chat/route.ts
4ï¸âƒ£ Align messages properly in Message.tsx (sent on right, received on left)
5ï¸âƒ£ Sync profile names & pictures by fetching /api/users on state change